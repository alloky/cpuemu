# Описание системы команд виртуальной машины


## Общие сведения

Комманды перечислены в порядке возврастания номеров, младшая комманда имеет номер 0. 
Их номер генерируется по enum'у, они объявляются макросами в [файле](cpuemu/include/cpuemu-cmd-defs.h)

Сигнатура каждой инструкции стандартная:

` [sizeof(char) - номер команды][sizeof(ARG_0) - первый аргумент] [sizeof(ARG_1) - второй аргумент] `

Количество аргументов переменное, они парсятся в зависимости от команды

Все регистры имеют размер sizeof(long long). Всего в ВМ 16 публичных регистров и 16 приватных (без учета IP и SP)

Всегда исполняется та иструкция, на начало которой узкывает текущий IP

IP увеличивается при распозновании команд и аргументов, а также может быть изменён посредствам условных или безусловных переходов. Напрямую писать или читать IP нельзя

## Сигнатура байт кода

В начале файла с байт кодом должна лежать его сигнатруа, а именно вот такая струтура [Signature](cpuemu/include/Signature.h)


Лейаут структуры:

		char : V
		char : B
		char : C
		size_t : code_segment_addr
		size_t : data_segment_addr
		size_t : stack_segment_addr
		size_t : stack_size

Вначале идут три символа, VBC, для проверки соответствия формата файла. Далее идут адреса соовтвествующих сегментов в коде, из них адресс data не используется, т.к. вся адресация идёт относительно code_segment. Возможно в последующих версиях это изменится.

Адрес стека и размер стека хранятся в специальных "регистрах", также есть регистр для верхушки стека. Верхушка модифицируется при операциях над стеком

## Стековые команды

Данные команды не имеют аргументов (за исключением PUSH, MOV и прыжков, из-за легаси) и выполняют операции над стеком. Аргументы выпопливаются со стека. Результат кладут на стек, если он есть. Первым на стеки лежит первый аргумент команды.

- **ADD**
- **SUB**
- **MUL**
- **DIV** - деление без остатка
- **MOD** - остаток от деления
- **CMP** - сравнивает первый аргумент со вторым и выставляет флаги сравнения в приватных регистрах ВМ
- **MOV** - принимает первым аргументом номер регистра, записывает в него выпопленое значение со стека

Не стековые команды. Условные переходы совершаются по флагам сравнения

- **JMP** - принимает один аргумент (size_t), остальные аналогично
- **JL**
- **JLE**
- **JEQ**
- **JNE**
- **JGE**
- **JG**

Опять стековые:

- **PUSH** - один аргумент (long long), пушит его на стек
- **POP** - убирает со стека (long long)
- **IN** - считывает из стандартного потока ввода long long и кладёт его на стек
- **OUT** - вывод long long со стека
- **OUTC** - аналогично, но кастит верхушку стека к char


## Левосторонние команды

Дальше идёт группа групп команд, которые выполняют операции над последующими аргументами из байт-кода, записывая (по возможности) результат в левый операнд. 

- **ADDL**
- **SUBL**
- **MULL**
- **DIVL**
- **MODL**
- **MOVL**
- **ANDL**
- **CMPL**

Каждая сторка ниже на самом представляет из себя 6 подряд определенных команд, по типам аргументов

типы аргументов:

- **RL**  - (char)(long long)
- **RSZ** -(char)(size_t)
- **RR** - (char)(char)
- **RS** - (char)(char)
- **SR** - (char)(char)
- **RS** - (char)(char)


**R** - интерперетируется как номер регистра

**L** - как число

**SZ** - адресс из памяти для загрузки, начало - 0

**S** - номер регистра, в котором лежит адресс для загрузки из памяти
 
## Стеково-регистровые команды

Принимают номер регистра

- **PUSHR** - кладёт значение регистра в стек
- **POPR** - попает из стека значение в регистр
- **MEW** - незадокумментированная команда без аргументов 
- **CALL** - кладёт на стек текущий IP и совершает переход по первому аргументу (size_t)
- **RET** - выпопливает из стека адресс возврата и совершает переход по нему





